{{/* 
  Tag Filter Bar Partial
  Usage: {{ partial "tag-filter-bar.html" (dict "pages" .Pages "section" "blogs") }}
*/}}

{{ $pages := .pages }}
{{ $section := .section }}
{{ $tagConfig := index site.Data "tag-config" }}

{{/* Fallback configuration if data file is not available */}}
{{ if not $tagConfig }}
  {{ $tagConfig = dict 
    "tags" (dict)
    "fallback_colors" (slice "#3B82F6" "#1D4ED8" "#60A5FA" "#10B981" "#059669" "#34D399" "#8B5CF6" "#7C3AED" "#A78BFA")
    "display" (dict "max_visible_tags" 5 "show_dropdown" true "sort_by_weight" false)
  }}
{{ end }}

{{/* Collect all tags from non-draft pages */}}
{{ $allTags := slice }}
{{ range where $pages "Draft" "!=" true }}
  {{ $pageTags := slice }}
  {{ if eq $section "projects" }}
    {{ $pageTags = .Params.project_tags }}
  {{ else if eq $section "experience" }}
    {{ $pageTags = .Params.experience_tags }}
  {{ else if eq $section "blogs" }}
    {{ $pageTags = .Params.tags }}
  {{ else }}
    {{ $pageTags = .Params.tags }}
  {{ end }}
  
  {{ with $pageTags }}
    {{ $allTags = $allTags | union . }}
  {{ end }}
{{ end }}

{{/* Debug: Print collected tags */}}
<!-- DEBUG: Section: {{ $section }} -->
<!-- DEBUG: Total pages: {{ len $pages }} -->
<!-- DEBUG: All tags collected: {{ $allTags }} -->
<!-- DEBUG: Tag count: {{ len $allTags }} -->

{{ if gt (len $allTags) 0 }}
  {{/* Create slice of tags with weights and names for sorting */}}
  {{ $weightedTags := slice }}
  {{ range $tag := $allTags }}
    {{ $weight := 0 }}
    {{ $tagName := $tag }}
    {{ $foundInConfig := false }}
    
    {{/* Find the tag in config (case-insensitive) */}}
    {{ range $configTag, $config := $tagConfig.tags }}
      {{ if eq (lower $configTag) (lower $tag) }}
        {{ if in $config.sections $section }}
          {{ $weight = $config.weight | default 0 }}
          {{ $foundInConfig = true }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{/* If not found in config, use default weight and original case */}}
    {{ if not $foundInConfig }}
      {{ $weight = 0 }}
    {{ end }}
    
    {{ $weightedTags = $weightedTags | append (dict 
      "name" $tagName
      "weight" $weight
      "lowerName" (lower $tagName)
    ) }}
  {{ end }}
  
  {{/* Sort by weight (descending) and then by name (ascending) */}}
  {{ $sortedTags := sort (sort $weightedTags "lowerName" "asc") "weight" "desc" }}

  {{ $maxVisibleTags := $tagConfig.display.max_visible_tags | default 5 }}
  {{ $totalTags := len $sortedTags }}
  {{ $showDropdown := and $tagConfig.display.show_dropdown (gt $totalTags $maxVisibleTags) }}
  
  <div id="tag-filter" class="d-flex flex-wrap gap-2 justify-content-center mb-4" data-max-visible-tags="{{ $maxVisibleTags }}">
    <button class="btn btn-sm btn-outline-dark filter-tag-btn" data-tag="__all">All</button>
    
    {{/* Visible tags */}}
    {{ range $i, $tagObj := first $maxVisibleTags $sortedTags }}
      {{ $tag := $tagObj.name }}
      {{ $color := "" }}
      
      {{/* Determine tag color */}}
      {{ $tagConfig := index site.Data "tag-config" }}
      {{ $tagFound := false }}
      {{ range $configTag, $config := $tagConfig.tags }}
        {{ if eq (lower $configTag) (lower $tag) }}
          {{ if in $config.sections $section }}
            {{ $color = $config.color }}
            {{ $tagFound = true }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ if not $tagFound }}
        {{/* Use fallback color if tag not found or not in section */}}
        {{ $fallbackColors := $tagConfig.fallback_colors | default (slice "#3B82F6" "#1D4ED8" "#60A5FA" "#10B981" "#059669" "#34D399" "#8B5CF6" "#7C3AED" "#A78BFA") }}
        {{ $fallbackIdx := mod (len $tag) (len $fallbackColors) }}
        {{ $color = index $fallbackColors $fallbackIdx }}
      {{ end }}

      <button class="badge border-0 filter-tag-btn" 
              data-tag="{{ $tag | urlize }}"
              style="background-color: {{ $color }}; color: white">
        {{ $tag }}
      </button>
    {{ end }}
    
    {{/* Dropdown for overflow tags */}}
    {{ if $showDropdown }}
      {{ $remainingCount := sub $totalTags $maxVisibleTags }}
      <div class="dropdown filter-dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle filter-dropdown-btn" 
                type="button" 
                id="filterDropdown-{{ $section }}" 
                data-bs-toggle="dropdown" 
                aria-expanded="false">
          +{{ $remainingCount }} more
        </button>
        <ul class="dropdown-menu filter-dropdown-menu" aria-labelledby="filterDropdown-{{ $section }}">
          {{ range $i, $tagObj := after $maxVisibleTags $sortedTags }}
            {{ $tag := $tagObj.name }}
            {{ $color := "" }}
            {{ $tagFound := false }}
            
            {{/* Determine tag color */}}
            {{ range $configTag, $config := $tagConfig.tags }}
              {{ if eq (lower $configTag) (lower $tag) }}
                {{ if in $config.sections $section }}
                  {{ $color = $config.color }}
                  {{ $tagFound = true }}
                {{ end }}
              {{ end }}
            {{ end }}
            {{ if not $tagFound }}
              {{/* Use fallback color if tag not found or not in section */}}
              {{ $fallbackColors := $tagConfig.fallback_colors | default (slice "#3B82F6" "#1D4ED8" "#60A5FA" "#10B981" "#059669" "#34D399" "#8B5CF6" "#7C3AED" "#A78BFA") }}
              {{ $fallbackIdx := mod (len $tag) (len $fallbackColors) }}
              {{ $color = index $fallbackColors $fallbackIdx }}
            {{ end }}

            <li class="d-flex">
              <button class="badge border-0 filter-tag-btn w-100 text-start" 
                      data-tag="{{ $tag | urlize }}"
                      style="background-color: {{ $color }}; color: white; margin: 0.125rem 0;">
                {{ $tag }}
              </button>
            </li>
          {{ end }}
        </ul>
      </div>
    {{ end }}
  </div>
{{ end }}
