{{/* 
  Tag System Partial
  Usage: {{ partial "tag-system.html" (dict "tags" .Params.tags "section" "blogs" "context" .) }}
  or: {{ partial "tag-system.html" (dict "tags" .Params.project_tags "section" "projects" "context" .) }}
*/}}

{{ $tags := .tags }}
{{ $section := .section }}
{{ $context := .context }}
{{ $tagConfig := index site.Data "tag-config" }}

{{/* Fallback configuration if data file is not available */}}
{{ if not $tagConfig }}
  {{ $tagConfig = dict 
    "tags" (dict)
    "fallback_colors" (slice "#3B82F6" "#1D4ED8" "#60A5FA" "#10B981" "#059669" "#34D399" "#8B5CF6" "#7C3AED" "#A78BFA")
    "display" (dict "max_visible_tags" 5 "show_dropdown" true "sort_by_weight" false)
  }}
{{ end }}

{{ if $tags }}
  {{ $sortedTags := slice }}
  
  {{/* Create slice of tags with weights and names for sorting */}}
  {{ $weightedTags := slice }}
  {{ range $tag := $tags }}
    {{ $weight := 0 }}
    {{ $tagName := $tag }}
    {{ $foundInConfig := false }}
    
    {{/* Find the tag in config (case-insensitive) */}}
    {{ range $configTag, $config := $tagConfig.tags }}
      {{ if eq (lower $configTag) (lower $tag) }}
        {{ if in $config.sections $section }}
          {{ $weight = $config.weight | default 0 }}
          {{ $foundInConfig = true }}
        {{ end }}
      {{ end }}
    {{ end }}
    
    {{ $weightedTags = $weightedTags | append (dict 
      "name" $tagName
      "weight" $weight
      "lowerName" (lower $tagName)
    ) }}
  {{ end }}
  
  {{/* Sort by weight (descending) and then by name (ascending) */}}
  {{ $sortedTags = sort (sort $weightedTags "lowerName" "asc") "weight" "desc" }}

  <div class="tag-container pt-1" data-max-visible-tags="{{ $tagConfig.display.max_visible_tags | default 3 }}">
    <div class="tag-list d-flex flex-wrap gap-1">
      {{ range $i, $tagObj := $sortedTags }}
        {{ $tag := $tagObj.name }}
        {{ $color := "" }}
        {{ $tagUrl := "" }}
        
        {{/* Determine tag color */}}
        {{ $color = "" }}
        {{ $tagFound := false }}
        
        {{/* Find the tag in config (case-insensitive) */}}
        {{ range $configTag, $config := $tagConfig.tags }}
          {{ if eq (lower $configTag) (lower $tag) }}
            {{ if in $config.sections $section }}
              {{ $color = $config.color }}
              {{ $tagFound = true }}
            {{ end }}
          {{ end }}
        {{ end }}
        
        {{/* Use fallback color if tag not found or not in section */}}
        {{ if not $tagFound }}
          {{ $fallbackColors := $tagConfig.fallback_colors | default (slice "#3B82F6" "#1D4ED8" "#60A5FA" "#10B981" "#059669" "#34D399" "#8B5CF6" "#7C3AED" "#A78BFA") }}
          {{ $fallbackIdx := mod (len $tag) (len $fallbackColors) }}
          {{ $color = index $fallbackColors $fallbackIdx }}
        {{ end }}

        {{/* Determine tag URL based on section */}}
        {{ if eq $section "projects" }}
          {{ $tagUrl = printf "/project_tags/%s/" ($tag | urlize) }}
        {{ else if eq $section "experience" }}
          {{ $tagUrl = printf "/experience_tags/%s/" ($tag | urlize) }}
        {{ else if eq $section "blogs" }}
          {{ $tagUrl = printf "/tags/%s/" ($tag | urlize) }}
        {{ else }}
          {{ $tagUrl = printf "/tags/%s/" ($tag | urlize) }}
        {{ end }}

        <a class="badge tag-chip border-0"
           href="{{ $tagUrl }}"
           data-filter="{{ $tag | urlize }}"
           style="background-color: {{ $color }}; color: white; text-decoration: none;">
          {{ $tag }}
        </a>
      {{ end }}
    </div>
  </div>
{{ end }}
