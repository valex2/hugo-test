{{ define "main" }}
<section class="py-5">
  <div class="container">
    <h3 class="text-center">{{ .Title }}</h3>
    {{ with .Content }}<div class="text-center mb-4">{{ . }}</div>{{ end }}

    {{/* Collect all project tags (preserving case) */}}
    {{ $allTags := slice }}
    {{ range .Pages }}
      {{ with .Params.project_tags }}
        {{ $allTags = $allTags | union . }}
      {{ end }}
    {{ end }}

    {{ $colors := slice "primary" "secondary" "success" "danger" "warning" "info" }}

    {{ if gt (len $allTags) 0 }}
    <div id="tag-filter" class="d-flex flex-wrap gap-2 justify-content-center mb-4">
      <button class="btn btn-sm btn-outline-dark" data-tag="__all">All</button>
      {{ range $i, $t := $allTags }}
        {{ $idx := mod (len $t) (len $colors) }}
        <button class="badge border-0 bg-{{ index $colors $idx }}" data-tag="{{ $t | urlize }}">
          {{ $t }}
        </button>
      {{ end }}
    </div>
    {{ end }}

    <div id="blog-grid" class="row justify-content-center px-3 px-md-5">
      {{ range .Paginator.Pages }}
        {{ $tags := .Params.project_tags }}
        {{ $tagsUrlized := slice }}
        {{ range $t := $tags }}{{ $tagsUrlized = $tagsUrlized | append ($t | urlize) }}{{ end }}
        <div class="col-lg-4 col-md-6 my-3 post-card" data-tags="{{ delimit $tagsUrlized " " }}">
          <div class="card h-100">

            {{/* ---- Card Image (cover -> featuredImage -> first bundle match) ---- */}}
            {{ $img := or .Params.cover .Params.featuredImage }}
            {{ with $img }}
              <img
                src="{{ . | relURL }}"
                alt="{{ $.Title }}" loading="lazy" decoding="async"
                class="card-img-top obj-cover aspect-16x9">
            {{ else }}
              {{ with .Resources.GetMatch (or .Params.cardImage "cover*") }}
                {{ $card := .Fit "768x432 webp q75" }}
                <img
                  src="{{ $card.RelPermalink }}"
                  width="{{ $card.Width }}" height="{{ $card.Height }}"
                  alt="{{ $.Title }}" loading="lazy" decoding="async"
                  class="card-img-top obj-cover aspect-16x9">
              {{ end }}
            {{ end }}

            <div class="card-body p-3">
              <h5 class="card-title mt-1"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h5>
              <div class="text-secondary">
                <small>{{ with .Date }}{{ .Format "Jan 2, 2006" }}{{ end }}</small>
              </div>
              {{ with or .Params.summary .Params.description }}
                <p class="card-text mt-2">{{ . }}</p>
              {{ end }}
              {{ if $tags }}
              <div class="pt-1 d-flex flex-wrap gap-1">
                {{ range $t := $tags }}
                  {{ $idx := mod (len $t) (len $colors) }}
                  <a class="badge bg-{{ index $colors $idx }} tag-chip"
                     href="/project_tags/{{ $t | urlize }}/"
                     data-filter="{{ $t | urlize }}">
                    {{ $t }}
                  </a>
                {{ end }}
              </div>
              {{ end }}
            </div>
          </div>
        </div>
      {{ end }}
    </div>

    {{ template "_internal/pagination.html" . }}
  </div>
</section>

<link rel="stylesheet" href="/css/blog-tags.css">
<script src="/js/tag-filter.js" defer></script>
<link rel="stylesheet" href="/css/callouts.css">
<script src="/js/callouts.js" defer></script>
{{ end }}
