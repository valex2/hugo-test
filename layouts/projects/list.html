{{ define "main" }}
<section class="py-5">
  <div class="container">
    <h3 class="text-center">{{ .Title }}</h3>
    {{ with .Content }}<div class="text-center mb-4">{{ . }}</div>{{ end }}

    {{/* Tag filter bar */}}
    {{ partial "tag-filter-bar.html" (dict "pages" .Pages "section" "projects") }}

    {{/* Filter out any pages that don't have a title or are the _index.md file */}}
    {{ $validProjects := slice }}
    {{ range .Pages }}
      {{ if and .Title (ne .File.LogicalName "_index.md") }}
        {{ $validProjects = $validProjects | append . }}
      {{ end }}
    {{ end }}

    <div id="project-grid" class="row justify-content-center px-3 px-md-5">
      {{ range $index, $p := $validProjects }}
        {{ $tags := $p.Params.project_tags | default slice }}
        {{ $tagsUrlized := slice }}
        {{ range $t := $tags }}{{ $tagsUrlized = $tagsUrlized | append ($t | urlize) }}{{ end }}
          <div class="col-lg-4 col-md-6 my-3 project-card" data-tags="{{ delimit $tagsUrlized " " }}">
            <div class="card h-100">
              {{/* ------------ Card Image Resolver ------------- */}}
              {{ $imgParam := or $p.Params.cover (or $p.Params.featuredImage $p.Params.image) }}
              {{ if $imgParam }}
                {{ $isAbs := or (hasPrefix $imgParam "http://") (or (hasPrefix $imgParam "https://") (hasPrefix $imgParam "/")) }}
                <div class="card-img-top" style="height: 200px; overflow: hidden; background-color: #f8f9fa;">
                  {{ if $isAbs }}
                    <img src="{{ $imgParam | relURL }}" 
                         alt="{{ $p.Title }}" 
                         style="width: 100%; height: 100%; object-fit: contain; object-position: center;">
                  {{ else }}
                    {{ $imagePath := printf "/images/projects/%s" $imgParam }}
                    {{ $imageResource := resources.Get $imagePath }}
                    {{ if $imageResource }}
                      <img src="{{ $imageResource.RelPermalink }}" 
                           alt="{{ $p.Title }}" 
                           style="width: 100%; height: 100%; object-fit: contain; object-position: center;">
                    {{ end }}
                  {{ end }}
                </div>
              {{ end }}
              {{/* ------------ /Card Image Resolver ------------- */}}

              <div class="card-body p-3">
                <h5 class="card-title mt-1"><a href="{{ $p.RelPermalink }}" class="text-decoration-none">{{ $p.Title }}</a></h5>
                <div class="text-muted">
                  <small>{{ $p.Date.Format "Jan 2, 2006" }}</small>
                </div>
                {{ with or $p.Params.summary $p.Description }}
                  <p class="card-text mt-2 text-muted">{{ . | truncate 150 }}</p>
                {{ end }}
                {{ if $tags }}
                  {{ partial "tag-system.html" (dict "tags" $tags "section" "projects" "context" $p) }}
                {{ end }}
              </div>
            </div>
          </div>
      {{ end }}
    </div>

    {{ template "_internal/pagination.html" . }}
  </div>
</section>

<link rel="stylesheet" href="/css/blog-tags.css">
<script src="/js/tag-filter.js" defer></script>
<link rel="stylesheet" href="/css/callouts.css">
<script src="/js/callouts.js" defer></script>
<link rel="stylesheet" href="/css/layout-fixes.css">
{{ end }}
